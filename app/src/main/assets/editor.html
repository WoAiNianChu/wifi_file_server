<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>编辑</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
  
  
  
  
  
  
<style>html {
  font-family: Roboto, Helvetica Neue, Arial, sans-serif;
  height: 100%
}

body {
  font-size: small;
  margin: 0;
  background: #fff;
  color: #4d5156;
  background-color: #fff;
  overflow: initial;
  font-family: 'pingfang SC', 'helvetica neue', arial, 'hiragino sans gb', 'microsoft yahei ui', 'microsoft yahei', simsun, sans-serif;
  height: 100%
}

textarea {
  height: calc(100% - 56px - 49px);
  resize: none;
  border: none;
  width: 100%;
  font-size: 18px;
  padding: 12px;
  box-sizing: border-box;
  font-family: 'pingfang SC', 'helvetica neue', arial, 'hiragino sans gb', 'microsoft yahei ui', 'microsoft yahei', simsun, sans-serif;
}

:focus {
  outline: none;
}</style></head>

<body>
  <custom-drawer bind="customDrawer"></custom-drawer>
  <custom-header title="编辑" bind="" @submit="showDrawer"></custom-header>
  <div style="height: 56px;"></div>
  <textarea bind="textarea"></textarea>
  <custom-bottom-bar bind="customBottomBar" @submit="navigate"></custom-bottom-bar>
  <custom-toast id="toast"></custom-toast>
  <custom-dialog-replace bind="customDialogReplace" @submit="findAndReplaceHandler" style="display: none;"></custom-dialog-replace>
  
  <script>
    function formattingJavaScript(textarea) {
      const options = { indent_size: 2, space_in_empty_paren: true }

      let selected = getSelectedString(textarea);
      let str = selected || textarea.value;
      let s;

      if (str.indexOf('</html>') !== -1 || str.indexOf('</view>') !== -1 || str.startsWith("<div")) {
        s = html_beautify(str, options);
      } else if (/\)\s+{/.test(str)) {
        s = js_beautify(str, options);
      } else {
        s = css_beautify(str, options);
      }
      //const s = str.indexOf('</html>')!==-1 ? : ;
      if (selected) {
        replaceSelectedText(textarea, s)
      } else {
        textarea.value = s;
      }
    }
  </script>
<script type="module">import {
  LitElement,
  html,
  css
} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';
export class CustomHeader extends LitElement {
  static properties = {
    title: {},
    show: {
      state: false
    },
    flat: {
      attribute: true,
      hasChanged: (newVal, oldVal) => {
        return true;
      }
    }
  };
  static styles = css`.header{color:black;min-width:320px;transition:box-shadow 250ms;top:0;width:100%;display:block;font:13px/27px Roboto,Arial,sans-serif;z-index:986;position:fixed;left:0;right:0;background-color:rgba(255,255,255,1);}.wrapper{box-sizing:border-box;position:relative;width:100%;display:flex;justify-content:space-between;transition:background-color .4s;padding:4px;padding-left:8px;min-width:0;}.left{height:48px;vertical-align:middle;white-space:nowrap;-webkit-box-align:center;align-items:center;display:flex;-webkit-user-select:none;box-sizing:border-box;padding-right:14px;flex:1 1 auto;overflow:hidden;}.middle{height:48px;white-space:nowrap;align-items:center;display:flex;-webkit-user-select:none;justify-content:flex-end;flex:0 0 auto;}.svg{fill:currentColor;opacity:1;border-radius:50%;padding:8px;margin:3px;color:unset;margin-left:1px;margin-right:1px;}.title{display:inline-block;font-size:22px;line-height:24px;position:relative;vertical-align:middle;color:#5f6368;opacity:1;padding-left:0;}.hamburger-menu{border-radius:50%;display:inline-block;padding:12px;overflow:hidden;vertical-align:middle;cursor:pointer;height:24px;width:24px;-webkit-user-select:none;flex:0 0 auto;margin:0 4px 0 0;}`;

  constructor() {
    super();
  }
  showDrawer() {
    this.dispatchEvent(new CustomEvent('submit'));
  }
  render() {
    return html`<div class="header" style="${this.show ? 'box-shadow:0px 4px 5px 0px rgb(0 0 0 / 14%), 0px 1px 10px 0px rgb(0 0 0 / 12%), 0px 2px 4px -1px rgb(0 0 0 / 20%)' : ''}">
    <div class="wrapper">
        <div class="left">
            <div class="hamburger-menu" @click="${this.showDrawer}">
                <svg focusable="false" viewbox="0 0 24 24">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path>
                </svg>
            </div>
            <div class="title">${this.title}</div>
        </div>
        <div class="middle">
            <svg class="svg" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.49,19l-5.73-5.73C15.53,12.2,16,10.91,16,9.5C16,5.91,13.09,3,9.5,3S3,5.91,3,9.5C3,13.09,5.91,16,9.5,16 c1.41,0,2.7-0.47,3.77-1.24L19,20.49L20.49,19z M5,9.5C5,7.01,7.01,5,9.5,5S14,7.01,14,9.5S11.99,14,9.5,14S5,11.99,5,9.5z"></path>
                <path d="M0,0h24v24H0V0z" fill="none"></path>
            </svg>
        </div>
    </div>
</div>`;
  }
  scroll() {
    this.show = window.scrollY > 56;
  }
  connectedCallback() {
    super.connectedCallback();
    if (!this.flat) {
      this.scrollHandler = this.scroll.bind(this);
      document.addEventListener("scroll", this.scrollHandler)
    }
  }
}
customElements.define('custom-header', CustomHeader);
/*
<!--
<script type="module" src="../components/custom-header.js"></script>
<custom-header></custom-header>
-->
*/</script><script type="module">import {
  LitElement,
  html,
  css
} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';
export class CustomDrawer extends LitElement {
  static properties = {
    expand: {},
    data: {}
  };
  static styles = css`.name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.main{display:flex;flex:1 1 auto;flex-direction:column;}.overlay{position:fixed;right:0;top:0;left:0;bottom:0;z-index:991;cursor:pointer;}.top{position:relative;top:2px;-webkit-user-select:none;min-height:48px;display:table-cell;height:48px;vertical-align:middle;padding-top:4px;padding-bottom:4px;padding-left:16px;}.item{text-decoration:none;letter-spacing:.01785714em;font-size:.875rem;font-weight:500;line-height:1.25rem;height:48px;display:flex;-webkit-box-align:center;align-items:center;padding-left:24px;padding-right:12px;margin-right:8px;border-radius:0 50px 50px 0;cursor:pointer;color:inherit;}.wrapper{background-color:#fff;bottom:0;color:#000;overflow-x:hidden;position:fixed;top:0;bottom:0;z-index:992;will-change:visibility;display:flex;flex-direction:column;}.divider{border-bottom:1px solid #e8eaed;margin:8px 8px 8px 0;}`;

  constructor() {
    super();
    this.data = [{
      path: `<path d="M9.984 20.016h-4.969v-8.016h-3l9.984-9 9.984 9h-3v8.016h-4.969v-6h-4.031v6z"></path>
`,
      name: "首页",
      href: "/backend/index"
    }];
  }
  show() {
    this.expand = true;
  }
  hide() {
    this.expand = null;
  }
  render() {

    return html`<div class="wrapper" style="${this.expand ? 'transform: translateX(0);visibility: visible;box-shadow: 0 0 16px rgba(0,0,0,.28);transition: transform .25s cubic-bezier(0.4,0.0,0.2,1),visibility 0s linear 0s;overflow-y: visible;width: 256px;' : 'transition:transform .25s cubic-bezier(0.4,0.0,0.2,1),visibility 0s linear .25s;transform:translateX(-264px)'}" @click="${this.hide}">
  <div class="top">
  </div>
  <div class="main">
    ${this.data .map((element,index)=>{
const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
svg.setAttribute('viewBox', '0 0 24 24');
    svg.innerHTML=element.path;
 
    return html`<a class="item" href="${element.href}">
<div style="width: 24px;height: 24px;fill: currentColor;color: #333;display:flex;align-items: center;justify-content: center;margin-right: 16px;">
  ${svg}
</div> 
      <div class="name">
        ${element.name}
      </div>
    </a>`;
})}
  </div>
</div>
<div class="overlay" @click="${this.hide}" style="${this.expand?'display:block':'display:none'}"></div>`;
  }
  connectedCallback() {
    super.connectedCallback();

  }
  disconnectedCallback() {}
}
customElements.define('custom-drawer', CustomDrawer);
/*
<!--
<script type="module" src="./components/custom-drawer.js"></script>
<custom-drawer></custom-drawer>


-->
*/</script><script type="module">import {
  LitElement,
  html,
  css
} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';
export class CustomBottomBar extends LitElement {
  static properties = {
    data: {},
    end: {
      state: true
    },
  };
  static styles = css`.item-title {
  max-width: 100%;
  padding: 0 4px;
  box-sizing: border-box;
  display: block;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.item {

  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1 1 0%;
  min-width: 0;
  flex-direction: column;

}

:host {
  display: flex;
  justify-content: space-around;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  z-index: 3;
  height: 48px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: #0f0f0f;
  font-size: 12px;
  background: #fff;
user-select:none;
}`;

  constructor() {
    super();
this.data=[];
  }
  navigate(e) {
    this.dispatchEvent(new CustomEvent('submit', {
      detail: e.currentTarget.dataset.href
    }));
  }
  render() {
    return html`${this.data .map((element,index)=>{
const svg=document.createElementNS("http://www.w3.org/2000/svg",'svg');
svg .setAttribute('viewBox','0 0 24 24');
svg.style="width:24px;height:24px;"
svg.innerHTML=element.path
return html`<div class="item" data-href="${element.href}" @click="${this.navigate}">
${svg}
<div class="item-title">
${element.title}
  </div>
  </div>`;
})}`;
  }
  connectedCallback() {
    super.connectedCallback();
  
  }
}
customElements.define('custom-bottom-bar', CustomBottomBar);
/*
<!--
<script type="module" src="./components/custom-bottom-bar.js"></script>
<custom-bottom-bar></custom-bottom-bar>
-->
*/
</script><script type="module">import {
  LitElement,
  html,
  css
} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';
export class CustomDialogActions extends LitElement {
  static properties = {
    data: {}
  };
  static styles = css`
.item{
      background:#fff;padding:9px 12px;display:flex;align-items: center;justify-content: center;
      }:host {
  color: #0f0f0f;
  -webkit-text-size-adjust: 100%;
  font-size: 12px;
  z-index: 1002;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.dialog {
  position: relative;
  z-index: 1002;
  max-height: 180px;
  overflow-y: auto;
  color: #0f0f0f;
  min-width: 250px;
  max-width: 356px;
  margin: 40px;
  border-radius: 8px;
  background-color: #fff;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  background-color: #dadce0;
overflow-y:auto;

}
.dialog::-webkit-scrollbar{
display:none;
}
.overlay {
  font-family: Roboto, Arial, sans-serif;
  word-wrap: break-word;
  color: #0f0f0f;
  -webkit-text-size-adjust: 100%;
  font-size: 1.2rem;
  position: fixed;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1001;
  cursor: pointer;
  background-color: rgba(0, 0, 0, 0.3);
}`;

  constructor() {
    super();
    this.data = ["参数列表","缩进","排序行","上传图片","注释","代码块","代码段","SQL","翻译中文","执行代码","预览","链接","替换"];
  }
  close() {
    this.remove();
  }
  navigate(evt) {
    const index = evt.currentTarget.dataset.index;
    this.dispatchEvent(new CustomEvent('submit', {
      detail: index
    }));
  }
  render() {
    return html`<div class="dialog">
${this.data .map((element,index)=>{
return html`<div class="item" data-index="${index}" @click="${this.navigate}">${element}</div>`;
})}
  </div>
<div class="overlay" @click="${this.close}">
  </div>`;
  }
  connectedCallback() {
    super.connectedCallback();
  }
}
customElements.define('custom-dialog-actions', CustomDialogActions);
/*
<!--
<script type="module" src="./components/custom-dialog-actions.js"></script>
<custom-dialog-actions></custom-dialog-actions>
-->
*/</script><script type="module">class CustomToast extends HTMLElement {
    static get observedAttributes() {
        return ['message'];
    }
    // Fires when an instance of the element is created or updated
    constructor() {
        super();
        this.root = this.attachShadow({
            mode: 'open'
        });
        const style = document.createElement('style');
        style.textContent = CustomToast.getStyle();
        this.root.appendChild(style);
        const c3Toast = document.createElement('DIV');
        c3Toast.setAttribute('class', 'c3-toast');

        const notificationActionRenderer = document.createElement('DIV');
        notificationActionRenderer.setAttribute('class', 'notification-action-renderer');
        const notificationActionResponseText = document.createElement('DIV');
        notificationActionResponseText.setAttribute('class', 'notification-action-response-text');
        notificationActionRenderer.appendChild(notificationActionResponseText);
        c3Toast.appendChild(notificationActionRenderer);
        this.root.appendChild(c3Toast);

        this.c3Toast = c3Toast;
        this.notificationActionResponseText = notificationActionResponseText;
        this.messages = [];
        this.timer = 0;
    }

    // Fires when an instance was inserted into the document
    connectedCallback() {}

    // Fires when an instance was removed from the document
    disconnectedCallback() {}

    showMessage() {
        if (this.messages.length && !this.showing) {
            const message = this.messages.shift();
            this.notificationActionResponseText.textContent = message;
            this.c3Toast.setAttribute('dir', 'in');
            this.showing = true;
            if (this.timer) {
                clearTimeout(this.timer);
            }
            this.timer = setTimeout(() => {
                this.c3Toast.setAttribute('dir', 'out');
                setTimeout(() => {
                    this.showing = false;
                    this.showMessage();
                }, 195);
            }, 3000);
        }
    }
    // Fires when an attribute was added, removed, or updated
    attributeChangedCallback(attrName, oldVal, newVal) {
        if (attrName === 'message') {
            this.messages.push(newVal);
            this.showMessage();
        }
    }

    // Fires when an element is moved to a new document
    adoptedCallback() {}
    static getTemplate(value) {
        return `
        ${CustomToast.getStyle()}
        <div>
            ${value}
        </div>
        `;
    }
    static getStyle() {
        return `
        .c3-toast[dir="in"] {
            transition: margin 225ms cubic-bezier(0.0, 0.0, 0.2, 1);
            margin-top: 0;
        }
        
        .c3-toast[dir="out"] {
            transition: margin 195ms cubic-bezier(0.4, 0.0, 1, 1);
        }
        
        .c3-toast {
            display: block;
            position: fixed;
            z-index: 999;
            left: 0;
            right: 0;
            top: 0;
            box-sizing: border-box;
            padding: 14px 24px;
            font-size: 1.4rem;
            color: #ffffff;
            background: hsl(0, 0%, 20%);
            will-change: transform;
            margin-top: -100%;
        }
        
        .notification-action-renderer {
            display: flex;
            align-items: center;
        }
        
        .notification-action-response-text {
            flex-grow: 1;
            padding-right: 1rem;
            font-size:14px;
        }
        
        `;
    }
}
customElements.define('custom-toast', CustomToast);
/*
<!--
<custom-toast id="toast"></custom-toast>
<script src="toast.js"></script>
 document.getElementById('toast').setAttribute('message','');-
-->
*/</script><script type="module">import {
  LitElement,
  html,
  css
} from 'https://cdn.jsdelivr.net/gh/lit/dist@2/core/lit-core.min.js';
export class CustomDialogReplace extends LitElement {
  static properties = {
    message: {},

    title: {},
    find: {},
    repalce: {},
    data: {}
  };
  static styles = css`.wrapper{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;z-index:4;margin:0 40px;padding:0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}.dialogReplace{position:relative;z-index:2;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;max-height:100%;box-sizing:border-box;padding:16px;margin:0 auto;overflow-x:hidden;overflow-y:auto;font-size:13px;color:#0f0f0f;border:none;min-width:250px;max-width:356px;box-shadow:0 0 24px 12px rgba(0,0,0,0.25);border-radius:12px;background-color:#fff;}.dialogReplace-header{display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;flex-shrink:0;}.h2{margin:0 0 3px;display:-webkit-box;-webkit-box-orient:vertical;max-height:2.5em;-webkit-line-clamp:2;overflow:hidden;line-height:1.25;text-overflow:ellipsis;font-weight:normal;font-size:18px;}.dialogReplace-body{overflow-y:auto;overflow-x:hidden;max-height:100vh;white-space:pre-wrap;}.dialogReplace-buttons{display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:end;justify-content:flex-end;margin-top:12px;}.button{display:flex;align-items:center;justify-content:center;padding:0 16px;height:36px;font-size:14px;line-height:36px;border-radius:18px;color:#0f0f0f;}.disabled{color:#909090}.overlay{position:fixed;top:0;bottom:0;left:0;right:0;z-index:1;cursor:pointer;background-color:rgba(0,0,0,0.3);}`;
  constructor() {
    super();
    this.message = null;

    this.title = "查找和替换";
    this.find = {};
    this.replace = {};
    this.data = [];
  }
  _close(evt) {
    evt.stopPropagation();
    this.style.display = "none";
    this.dispatchEvent(new CustomEvent('submit', {
      detail: 1
    }));
  }
  _submit(evt) {
    evt.stopPropagation();
    this.style.display = "none";
    this.dispatchEvent(new CustomEvent('submit', {
      detail: 2
    }));
  }
  /*
  {
        id,
        value: element.value
      }
      */
  _input(evt) {
    const element = evt.currentTarget;
    const id = element.dataset.id;
    if (id === "1") {
      this.find = element.value;
    } else if (id === "2") {
      this.replace = element.value;
    }
  }
  render() {
    return html`<div class="wrapper">
  <div class="dialogReplace">
    <div class="dialogReplace-header">
      <h2 class="h2">${this.title}</h2>
    </div>
    <div class="dialogReplace-body">
    
    <input type="text" data-id="1" @input="${this._input}">
    <input type="text" data-id="2" @input="${this._input}">
    </div>
    <div class="dialogReplace-buttons">
      <div class="button" @click="${this._close}">
        取消
      </div>
      <div class="button disabled" @click="${this._submit}">
        确定
      </div>
    </div>
  </div>
<div class="overlay" @click="${this._close}">
</div>
</div>
`;
  }
  connectedCallback() {
    super.connectedCallback();
  }
}
customElements.define('custom-dialog-replace', CustomDialogReplace);
/*
<!--
<script type="module" src="../components/custom-dialog-replace.js"></script>
<custom-dialog-replace bind @submit=""></custom-dialog-replace>
                                         -->
                                     */</script><script>
function showDrawer(evt) {
  evt.stopPropagation();
  customDrawer.setAttribute('expand', 'true');
}
function getLine() {
  let start = textarea.selectionStart;
  const strings = textarea.value;

  if (strings[start] === '\n' && start - 1 > 0) {
    start--;
  }
  while (start > 0 && strings[start] != '\n') {
    start--;
  }
  let end = textarea.selectionEnd;
  while (end - 1 < strings.length && strings[end] != '\n') {
    end++;
  }
  return [strings.substring(start, end), start, end]
}
async function translate(value, to) {
  try {
    const response = await fetch(`${window.location.protocol}//kpkpkp.cn/api/trans?q=${encodeURIComponent(value.trim())}&to=${to}`);
    const obj = await response.json();
    return obj.sentences.map((element, index) => {
      return element.trans;
    }).join(' ');
  } catch (error) {
    console.log(error);
  }
}
async function saveData() {
  const firstLine = textarea.value.trim().split("\n", 2)[0];
    const obj = {

        content: substringAfter(textarea.value.trim(), "\n"),
        title: firstLine.replace(/^#+ +/, ''),
    };
    const searchParams = new URL(window.location.href).searchParams;
    const id = searchParams.get('id');
    let baseUri = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://192.168.8.55:8089' : '';

    if (id) {
        obj._id = parseInt(id);
        obj.update_at = new Date().getTime();
    } else {
        obj.create_at = new Date().getTime();
        obj.update_at = new Date().getTime();
    }
    if (obj.title.indexOf('|') !== -1) {
        obj.tag = substringAfter(obj.title, '|').trim();
        obj.title = substringBefore(obj.title, '|').trim();
    }
    const response = await fetch(`${baseUri}/api/note`, {
        method: 'POST',
        body: JSON.stringify(obj)
    });
    const res = await response.text();
    if (id)
        document.getElementById('toast').setAttribute('message', '成功');
    else
        window.location = `${window.location.origin}${window.location.pathname}?id=${res}`
}
function getOptions() {
  const line = getLine()[0].trim();
  const names = [];
  let start = 0;
  for (let index = 0; index < line.length; index++) {
    if (line[index] === ' ' || line[index] === '=') {
      names.push(line.substring(start, index).trim())
      start = index + 1;
      while (line[index + 1] === ' ') {
        index++;
      }
      continue;
    }
    else if (line[index] === '"') {
      names.push(line.substring(start, index))
      start = index + 1;
      for (let j = index + 1; j < line.length; j++) {
        const element = line[j];
        if (element === '"') {
          names.push(line.substring(start, j))
          start = j + 1;
          index = j + 1;
          continue;
        }
      }
    }

  }
  names.push(line.substring(start).trim())
  return names;
}
function findBlock(textarea) {
  let start = textarea.selectionStart;
  let end = textarea.selectionEnd;
  const strings = textarea.value;
  if (strings[start] === '\n' && start - 1 > 0) {
    start--;
  }
  let founded = false;
  while (start > 0) {
    if (strings[start] == '\n') {
      let j = start - 1;
      while (j > 0 && /\s/.test(strings[j])) {
        if (strings[j] === '\n') {
          founded = true;
          break;
        }
        j--;
      }
    }
    if (founded) {
      break
    }
    start--;
  }
  founded = false;
  while (end + 1 < strings.length) {
    if (strings[end] == '\n') {
      let j = end + 1;
      while (j + 1 < strings.length && /\s/.test(strings[j])) {
        if (strings[j] === '\n') {
          founded = true;
          break;
        }
        j++;
      }
    }
    if (founded) {
      break
    }
    end++;
  }
  return [start, end]

}

async function loadData() {
    const response = await fetch(`${baseUri}/api/note?id=${id}`);
    return await response.json();
}
async function render() {
    textarea.value = localStorage.getItem("content");

    if (id) {
        try {
            const obj = await loadData(baseUri, id);
            document.title = obj.title;
            textarea.value = `# ${obj.title}|${obj.tag}
        
${obj.content.trim()}
        `
        } catch (error) {
            console.log(error)
        }
    }
}
async function uploadImage(image, name) {
  const form = new FormData();
  form.append('images', image, name)
  const response = await fetch(`https://lucidu.cn/v1/picture`, {
    method: 'POST',
    body: form
  });
  return await response.text();
}

function tryUploadImageFromClipboard(success, error) {
  navigator.permissions.query({
    name: "clipboard-read"
  }).then(result => {
    if (result.state === "granted" || result.state === "prompt") {
      navigator.clipboard.read().then(data => {
        console.log(data[0].types);
        const blob = data[0].getType("image/png");
        console.log(blob.then(res => {
          const formData = new FormData();
          formData.append("images", res, "1.png");
          fetch(`https://lucidu.cn/v1/picture`, {
            method: "POST",
            body: formData
          }).then(res => {
            return res.text();
          }).then(obj => {
            success(obj);
          })
        }).catch(err => {
          console.log(err)
          error(err);
        }))
      })
        .catch(err => {
          error(err);
        });
    } else {
      error(new Error());
    }
  });
}

function increaseIndent() {
  const points = findBlock(textarea);
  const lines = textarea.value.substring(points[0], points[1]).split('\n')
    .map(x => `    ${x}`);
  textarea.setRangeText(`\n\n${lines.join('\n')}`, points[0], points[1], 'end');
}
function formatOptions() {
  const array = getOptions();
  const buf = [];
  for (let index = 0; index < array.length; index++) {
    const element = array[index];
    buf.push(`- \`${element}\`：`);
  }
  textarea.setRangeText(`\n\n${buf.join('\n')}`, textarea.selectionStart, textarea.selectionEnd, 'end');
}
function sortLines() {
  const points = findBlock(textarea);
  const lines = textarea.value.substring(points[0], points[1]).split('\n')
    .sort((x, y) => x.localeCompare(y));
  textarea.setRangeText(`\n\n${lines.join('\n')}`, points[0], points[1], 'end');
}
function upload() {
  if (window.location.protocol === 'https:' || window.location.protocol === 'http:') {
    tryUploadImageFromClipboard((ok) => {
      const string = `![](https://static.lucidu.cn/images/${ok})\n\n`;
      textarea.setRangeText(string, textarea.selectionStart, textarea.selectionStart);
    }, (error) => {
      console.log(error);
      const input = document.createElement('input');
      input.type = 'file';
      input.addEventListener('change', async ev => {
        const file = input.files[0];
        const imageFile = await uploadImage(file, file.name);
        const string = `![](https://static.lucidu.cn/images/${imageFile})\n\n`;
        textarea.setRangeText(string, textarea.selectionStart, textarea.selectionStart);
      });
      input.click();
    });
  } else {
    const input = document.createElement('input');
    input.type = 'file';
    input.addEventListener('change', async ev => {
      const file = input.files[0];
      const imageFile = await uploadImage(file, file.name);
      const string = `![](https://static.lucidu.cn/images/${imageFile})\n\n`;
      textarea.setRangeText(string, textarea.selectionStart, textarea.selectionStart);
    });
    input.click();
  }
}

function replaceSelectedText(textarea, s) {
  textarea.setRangeText(s, textarea.selectionStart, textarea.selectionEnd);
}

function findExtendPosition(editor) {
  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  let string = editor.value;
  let offsetStart = start;
  while (offsetStart > 0) {
    if (!/\s/.test(string[offsetStart - 1]))
      offsetStart--;
    else {
      let os = offsetStart;
      while (os > 0 && /\s/.test(string[os - 1])) {
        os--;
      }
      if ([...string.substring(offsetStart, os).matchAll(/\n/g)].length > 1) {
        break;
      }
      offsetStart = os;
    }
  }
  let offsetEnd = end;
  while (offsetEnd < string.length) {
    if (!/\s/.test(string[offsetEnd + 1])) {

      offsetEnd++;
    } else {

      let oe = offsetEnd;
      while (oe < string.length && /\s/.test(string[oe + 1])) {
        oe++;
      }
      if ([...string.substring(offsetEnd, oe + 1).matchAll(/\n/g)].length > 1) {
        offsetEnd++;

        break;
      }
      offsetEnd = oe + 1;

    }
  }
  while (offsetStart > 0 && string[offsetStart - 1] !== '\n') {
    offsetStart--;
  }
  // if (/\s/.test(string[offsetEnd])) {
  //     offsetEnd--;
  // }
  return [offsetStart, offsetEnd];
}
async function removeLines(textarea) {
  if (textarea.selectionStart !== textarea.selectionEnd) {

    let start = textarea.selectionStart;
    let end = textarea.selectionEnd;

    while (start > -1) {
      if (textarea.value[start] === '\n') {
        let s = [];

        while (start > -1 && /\s/.test(textarea.value[start])) {
          s.push(textarea.value[start])
          start--;
        }
        if ([...s.join('').matchAll(/\n/g)].length > 2) {
          break;
        }
      }
      start--;
    }
    while (end + 1 < textarea.value.length) {
      if (textarea.value[end] === '\n') {
        let s = [];

        while (end + 1 < textarea.value.length && /\s/.test(textarea.value[end])) {
          s.push(textarea.value[end])
          end++;
        }
        if ([...s.join('').matchAll(/\n/g)].length > 2) {
          break;
        }
      }
      end++;
    }
    start++;

    if (typeof NativeAndroid !== 'undefined') {
      NativeAndroid.writeText(textarea.value.substring(start, end));
    } else {
      await navigator.clipboard.writeText(textarea.value.substring(start, end))
    }
    textarea.setRangeText('\n', start, end);
    textarea.selectionEnd = start;
  } else {
    // textarea.value = textarea.value.substring(textarea.selectionEnd);
    // textarea.selectionStart = 0;
    // textarea.selectionEnd = 0;
    // textarea.scrollLeft = 0;
    // textarea.scrollTop = 0;
    const p = findExtendPosition(textarea);

    let start = p[0];

    while (start > -1 && /\s/.test(textarea.value[start - 1])) {
      start--;
    }

    let end = p[1];
    while (end + 1 < textarea.value.length && /\s/.test(textarea.value[end + 1])) end++;

    if (typeof NativeAndroid !== 'undefined') {
      NativeAndroid.writeText(textarea.value.substring(start, end));
    } else {
      await navigator.clipboard.writeText(textarea.value.substring(start, end))
    }
    textarea.setRangeText('\n\n', start, end + 1);
    textarea.selectionEnd = start;
  }

}
async function translationFunction(textarea) {
  const points = getLine();
  const s = points[0];
  try {
    const response = await fetch(`http://kpkpkp.cn/api/trans?q=${encodeURIComponent(s)}&to=en`);
    const obj = await response.json();
    const n = camel(obj.sentences[0].trans);
    textarea.setRangeText(`${n[0].toLowerCase() + n.slice(1)}`, points[1], points[2], 'end')

  } catch (error) {
    console.log(error);
  }
}

function camel(string) {
  return string.replaceAll(/[ _-]([a-zA-Z])/g, m => m[1].toUpperCase());
}

function returnToParentDirectory() {
  const uri = `/?path=${encodeURIComponent(substringBeforeLast(path, "/"))}&isDir=1`;
  console.log(uri)
  window.location.href = uri
}

function getSelectedString(textarea) {
  return textarea.value.substring(
    textarea.selectionStart,
    textarea.selectionEnd
  );
}


function replaceSelected(textarea) {
  // const selectedString = getSelectedString(textarea).trim();
  // const firstLine = substringBefore(selectedString, "\n").trim().split(' ');
  // const content = substringAfter(selectedString, "\n").trim();
  // replaceSelectedText(textarea, content.replaceAll(
  //   firstLine[0], firstLine[1]
  // ))

  const points = findBlock(textarea);
  const start = points[0];
  const end = points[1];

  let s = textarea.value.substring(start, end).trim();
  console.log(s)

  const n = substringBefore(s, "\n").trim().split(' ');
  textarea.setRangeText(`
${substringAfter(s, '\n').trim().replaceAll(
    n[0], n[1]
  )
    }
`, start, end, "end")

}
function toBlocks(string) {
  let count = 0;
  let buf = [];
  const blocks = [];
  for (let i = 0; i < string.length; i++) {
    buf.push(string[i])
    if (string[i] === '{') {
      count++;
    } else if (string[i] === '}') {
      count--;
      if (count === 0) {
        blocks.push(buf.join(''))
        buf = [];
      }
    }
  }
  return blocks;
}
function substringBeforeLast(string, delimiter, missingDelimiterValue) {
  const index = string.lastIndexOf(delimiter);
  if (index === -1) {
    return missingDelimiterValue || string;
  } else {
    return string.substring(0, index);
  }
}

function jumpPage(textarea) {
  const line = getLine(textarea);
  const value = /(?<=(href|src)=")[^"]+(?=")/.exec(line);
  let src;
  if (!value) {
    if (path.endsWith(".html")) {
      src = 'http://127.0.0.1:8081/' + substringBeforeLast(substringAfter(path, "\\app\\"), ".");
    } else {
      src = substringBeforeLast(path, ".");
      src = `${window.location.origin}${window.location.pathname}?path=${encodeURIComponent(`${substringBeforeLast(substringBeforeLast(src, "/"), "/")}/${substringAfterLast(src, "/")}.html`)}`;
    }
    window.open(src);
    return
  }

  src = `${window.location.origin}${window.location.pathname}?path=${encodeURIComponent(`${substringBeforeLast(path, "/")}/${value[0]}`)}`;
  window.open(src);
}

function substringAfter(string, delimiter, missingDelimiterValue) {
  const index = string.indexOf(delimiter);
  if (index === -1) {
    return missingDelimiterValue || string;
  } else {
    return string.substring(index + delimiter.length);
  }
}
function substringBefore(string, delimiter, missingDelimiterValue) {
  const index = string.indexOf(delimiter);
  if (index === -1) {
    return missingDelimiterValue || string;
  } else {
    return string.substring(0, index);
  }
}
function substringAfterLast(string, delimiter, missingDelimiterValue) {
  const index = string.lastIndexOf(delimiter);
  if (index === -1) {
    return missingDelimiterValue || string;
  } else {
    return string.substring(index + delimiter.length);
  }
}
async function formatStyleLit(textarea) {
  let strings;
  if (typeof NativeAndroid !== 'undefined') {
    strings = NativeAndroid.readText()
  } else {
    strings = await navigator.clipboard.readText()
  }
  const lines = strings.split(';').map(x => x.trim());
  const properties = lines.filter(x => x.startsWith('--')).map(x => {
    const pieces = x.split(':');
    if (pieces.length > 1)
      return {
        key: pieces[0].trim(),
        value: pieces[1].trim()
      }
  });
  const source = lines.filter(x => !x.startsWith('--'))
    .map(x => {

      return x.replace(/var\([^\)]+\)/g, m => {
        const key = /--[a-zA-Z0-9-]+/.exec(m)[0];
        const founded = properties.filter(x => x.key === key);
        const value = /,([^\)]+)\)/.exec(m);
        console.log(founded)
        return founded && founded.length ? founded[0]["value"] : ((value && value[1]) || '')
      });
    });
  const s = source.join(';').replaceAll(/font: \d+ \d+px\/\d+px[^;]+;/g, m => {
    const r = /font: (\d+) (\d+px)\/(\d+px)[^;]+;/.exec(m);
    return `font-weight: ${r[1]};font-size: ${r[2]};line-height: ${r[3]};`;
  });
  strings = substringAfter(s, "-webkit-tap-highlight-color: transparent;");
  let points = substring(textarea.value, "css`", "`");
  if (points[0] === 0 && points[1] === 0) {
    points = substring(textarea.value, "<style>", "</style>");
  }
  let css = textarea.value.substring(points[0], points[1]).trim();
  if (css) {
    let klass = substringAfterLast(css, '}');
    css = substringBeforeLast(css, '}') + '}'
    css += `
    .${klass}{
    ${strings}
    }`;
    const options = { indent_size: 2, space_in_empty_paren: true }
    css = css_beautify(css, options);
    textarea.setRangeText(`<div class="${klass}">
  </div>`, textarea.selectionStart, textarea.selectionEnd, 'end');
    textarea.setRangeText(css, points[0], points[1], "end");

  } else {
    let klass = "wrapper";
    css += `
    .${klass}{
    ${strings}
    }`;
    const options = { indent_size: 2, space_in_empty_paren: true }
    css = css_beautify(css, options);
    textarea.setRangeText(`<div class="${klass}">
  </div>`, textarea.selectionStart, textarea.selectionEnd, 'end');
    textarea.setRangeText(css, points[0], points[1], "end");
  }



}

function substring(strings, prefix, suffix) {
  let start = strings.indexOf(prefix);
  if (start === -1) {
    return [0, 0]
  }
  start += prefix.length;
  let end = strings.indexOf(suffix, start);
  if (end === -1) {
    return [0, 0]
  }
  return [start, end]
}
function formatComment(editor) {
  let str;
  if (/\.(?:html|xml|wxml)$/.test(path)) {
    str = `<!--\n\n-->`;
  } else if (/\.(?:sql)$/.test(path)) {
    str = `-- `;
  } else {
    str = `/*\n\n*/`;
  }
  editor.setRangeText(str, editor.selectionStart, editor.selectionEnd);
}
async function pasteCode() {
  let strings;
  if (typeof NativeAndroid !== 'undefined') {
    strings = NativeAndroid.readText()
  } else {
    strings = await navigator.clipboard.readText()
  }
  textarea.setRangeText(`
\`\`\`pgsql

${strings}

\`\`\`
`, textarea.selectionStart, textarea.selectionEnd, 'end');
}
async function insertSnippet() {
  try {
    const strings = textarea.value.trim();
    const response = await fetch(`${window.location.protocol}//lucidu.cn/v1/snippet`, {
      method: "POST",
      body: JSON.stringify({
        key: substringBefore(strings, "\n"),
        value: substringAfter(strings, "\n"),
        language: 'javascript'
      })
    });
    await response.text();
  } catch (error) {
    console.log(error);
  }
}
function insertLitProperty() {
  const s = getSelectedString(textarea).trim();
  replaceSelectedText(textarea, `\${this.${s}}`)
  let str = textarea.value;
  str = str.replace(`static properties = {`, `static properties = {\n${s}:{},\n`);
  str = str.replace(`super();`, `super();\nthis.${s}=null;\n`);
  textarea.value = str;

}
function insertLitHandler() {
  const s = getSelectedString(textarea).trim();
  replaceSelectedText(textarea, `@click=\${this._${s}}`)
  let str = textarea.value;
  str = str.replace(`render()`, `_${s}(evt){
    evt.stopPropagation();
    this.style.display = "none";
    const index = evt.currentTarget.dataset.index;
    this.dispatchEvent(new CustomEvent('submit', {
      detail: index
    }));
  }\nrender()`);

  textarea.value = str;
}

async function executeSQL() {
  const p = findBlock(textarea);
  let strings = textarea.value.substring(p[0], p[1]);

  console.log(strings)
  const response = await fetch(`${window.location.protocol}//lucidu.cn/v1/sql?q=${encodeURIComponent(strings)}`, {
    headers: {
      "Authorization": window.localStorage.getItem("Authorization")
    }
  })

  const json = await response.json();
  let s;
  if (json.length === 1 && json[0].length === 1 && (json[0] + '').endsWith('=')) {
    s = atob(json[0][0])
  }
  else {
    s = JSON.stringify(json, '', '\t');
  }
  textarea.setRangeText(s,
    p[1],
    p[1],
    'end')
}
async function evalCode() {
  const p = findBlock(textarea);
  let strings = textarea.value.substring(p[0], p[1]);

  let s = eval(strings);

  textarea.setRangeText(`=${s}`,
    p[1],
    p[1],
    'end')
};
async function translateChinese() {
  let array1 = getLine();
  textarea.setRangeText(`\n\n${await translate(array1[0], 'zh')
    }
          `, array1[1], array1[2], 'end');
}
async function formatCode() {
  const s = getSelectedString(textarea).trim();
  if (s) {
    textarea.setRangeText(`\`${s}\``, textarea.selectionStart, textarea.selectionEnd, 'end');
  } else {
    let strings;
    if (typeof NativeAndroid !== 'undefined') {
      strings = NativeAndroid.readText()
    } else {
      strings = await navigator.clipboard.readText()
    }
    textarea.setRangeText(`
\`\`\`pgsql
${strings}
\`\`\`
`, textarea.selectionStart, textarea.selectionEnd, 'end');
  }
}

function insertComment() {
  let str;
  if (/\.(?:html|xml|wxml)$/.test(path)) {
    str = `<!--\n\n-->`;
  } else if (/\.(?:sql)$/.test(path)) {
    str = `-- `;
  } else {
    str = `/*\n\n*/`;
  }
  textarea.setRangeText(str, textarea.selectionStart, textarea.selectionEnd, "end");
}

async function insertLink() {
  let str;
  let url = await navigator.clipboard.readText();
  try {
    const response = await fetch(`/api/title?url=${encodeURIComponent(url)}`);
    if (response.status > 399 || response.status < 200) {
      throw new Error(`${response.status}: ${response.statusText}`)
    }
    const results = await response.text();
    str = `- [${results}](${url})`
  } catch (error) {
    console.log(error);
    str = `- [${getSelectedString(textarea)}](${url})`
  }
  await textarea.setRangeText(str, textarea.selectionStart, textarea.selectionEnd, 'end');

}

function findAndReplaceHandler() {

  textarea.value =
    textarea.value.replaceAll(customDialogReplace.find, customDialogReplace.replace);
}

function findAndReplace() {
  customDialogReplace.removeAttribute('style');
}

///////////////////////////////

document.querySelectorAll('[bind]').forEach(element => {
  if (element.getAttribute('bind')) {
    window[element.getAttribute('bind')] = element;
  }
  [...element.attributes].filter(attr => attr.nodeName.startsWith('@')).forEach(attr => {
    if (!attr.value) return;
    element.addEventListener(attr.nodeName.slice(1), evt => {
      window[attr.value](evt);
    });
  });
})
customBottomBar.data = [
  {
    path: `<path d="M17.016 11.016v-2.016h-4.031v-3.984h-1.969v3.984h-4.031v2.016h4.031v3.984h1.969v-3.984h4.031zM21.984 3.984v18l-3.984-3.984h-14.016q-0.797 0-1.383-0.609t-0.586-1.406v-12q0-0.797 0.586-1.383t1.383-0.586h16.031q0.797 0 1.383 0.586t0.586 1.383z"></path>
    `,
    title: "评论",
    href: "comment"
  },
  {
    path: `<path d="M14.578 16.594l4.641-4.594-4.641-4.594 1.406-1.406 6 6-6 6zM9.422 16.594l-1.406 1.406-6-6 6-6 1.406 1.406-4.641 4.594z"></path>
  `,
    title: "代码",
    href: "code"
  }, {
    path: `<path d="M21.516 20.484v-13.969q0-0.422-0.305-0.727t-0.727-0.305h-9.047l1.313 3.797h1.453v-1.266h1.266v1.266h4.547v1.313h-1.922q-0.703 2.344-2.391 4.219l3.281 3.281-0.938 0.891-3.094-3.094 1.031 3.094-1.969 2.531h6.469q0.422 0 0.727-0.305t0.305-0.727zM13.172 10.594l0.797 2.344 0.844 1.125q1.453-1.594 2.063-3.469h-3.703zM6.984 15.984q2.156 0 3.492-1.359t1.336-3.516q0-0.047-0.141-1.031h-4.688v1.734h2.953q-0.094 0.891-0.844 1.641t-2.109 0.75q-1.313 0-2.227-0.938t-0.914-2.25q0-1.359 0.914-2.297t2.227-0.938q1.266 0 2.063 0.797l1.313-1.266q-1.453-1.313-3.375-1.313-2.063 0-3.516 1.477t-1.453 3.539 1.453 3.516 3.516 1.453zM21 3.984q0.797 0 1.406 0.609t0.609 1.406v15q0 0.797-0.609 1.406t-1.406 0.609h-9l-0.984-3h-8.016q-0.797 0-1.406-0.609t-0.609-1.406v-15q0-0.797 0.609-1.406t1.406-0.609h6.984l1.031 3h9.984z"></path>
`,
    title: "英文",
    href: "english"
  }, {
    path: `<path d="M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z"></path>  `,
    title: "删除",
    href: "removeLine"
  }, {
    path: `<path d="M3 6h18v2.016h-18v-2.016zM3 12.984v-1.969h18v1.969h-18zM3 18v-2.016h18v2.016h-18z"></path>`,
    title: "菜单",
    href: "menu"
  }, {
    path: `<path d="M15 9v-3.984h-9.984v3.984h9.984zM12 18.984q1.219 0 2.109-0.891t0.891-2.109-0.891-2.109-2.109-0.891-2.109 0.891-0.891 2.109 0.891 2.109 2.109 0.891zM17.016 3l3.984 3.984v12q0 0.797-0.609 1.406t-1.406 0.609h-13.969q-0.844 0-1.43-0.586t-0.586-1.43v-13.969q0-0.844 0.586-1.43t1.43-0.586h12z"></path>
`,
    title: "保存",
    href: "save"
  }]
async function navigate(evt) {
  switch (evt.detail) {
    case "comment":
      insertComment();
      break;
    case 'english':
      let array = getLine();
      textarea.setRangeText(`\n\n${await translate(array[0], 'en')
        }
          `, array[1], array[2], 'end');
      break;
    case 'code':
      formatCode();
      break;
    case 'save':
      await saveData();
      break;
    case "removeLine":
      await removeLines(textarea);
      break;
    case 'menu':
      const customDialogActions = document.createElement('custom-dialog-actions');
      customDialogActions.addEventListener('submit', async evt => {
        switch (evt.detail) {
          case "0":
            customDialogActions.remove();
            formatOptions();
            break;
          case "1":
            customDialogActions.remove();
            increaseIndent();
            break;
          case "2":
            customDialogActions.remove();
            sortLines();
            break;
          case "3":
            customDialogActions.remove();
            upload();
            break;
          case "4":
            customDialogActions.remove();
            formatComment(textarea)
            break;
          case "5":
            customDialogActions.remove();
            pasteCode();
            break;
          case "6":
            customDialogActions.remove();
            insertSnippet();
            break;
          case "7":
            customDialogActions.remove();
            executeSQL();
            break;
          case "8":
            customDialogActions.remove();
            await translateChinese();
            break;
          case "9":
            customDialogActions.remove();
            evalCode();
            break;
          case "10":
            customDialogActions.remove();
            preview();
            break;
          case "11":
            customDialogActions.remove();
            insertLink();
            break;
          case "12":
            customDialogActions.remove();
            findAndReplace();
            break;
        }
      });
      document.body.appendChild(customDialogActions);
      break;
  }
}
const id = new URL(document.URL).searchParams.get('id') || 0;
let baseUri = window.location.host === "127.0.0.1:5500" ? 'http://127.0.0.1:8081' : ''
render();
function preview() {
  window.open(`article.html?id=${id}`, '_blank')
}
document.addEventListener('keydown', async evt => {
  if (evt.ctrlKey) {
    switch (evt.key) {
      case 's':
        evt.preventDefault();
        await saveData();
        break
      case 'l':
        evt.preventDefault();
        await insertLink();

        break
      case 'u':
        evt.preventDefault();
        upload();
        break;
      case 'h':
        replaceSelected(textarea)
        evt.preventDefault();
        break;
      case 'm':
        textarea.value = textarea.value.split('\n')
          .map(x => x.trim())
          .filter(x => x)
          .join('\n');
        evt.preventDefault();
        break
      case "j":
        jumpPage(textarea);
        evt.preventDefault();
        break;
      case "i":
        insertSnippet();
        evt.preventDefault();
        break;
      case "p":
        preview();
        evt.preventDefault();
        break;
      case "o":
        pasteCode();
        evt.preventDefault();
        break;
      case 'c':
        if (textarea.selectionStart === textarea.selectionEnd) {
          const p = findBlock(textarea);
          await navigator.clipboard.writeText(textarea.value.substring(p[0], p[1]))
          evt.preventDefault();
        }
        break;


    }
  } else if (evt.key === ' ' || evt.keyCode == 229) {
    if (!path) {
      return;
    }
    let start = textarea.selectionStart;
    let end = start;
    if (start > -1)
      start--;
    while (start > -1 && /[a-zA-Z0-9-]+/.test(textarea.value[start])) {
      start--;
    }
    start++;
    const key = textarea.value.substring(start, end).trim();
    if (!key) {
      return;
    }
    try {
      const response = await fetch(`${window.location.protocol}//lucidu.cn/v1/snippet?id=${key}`);
      const value = await response.json();
      evt.preventDefault();
      textarea.setRangeText(value.value, start, end, "end");
      await fetch(`${window.location.protocol}//lucidu.cn/v1/snippet?id=${key}`, {
        method: 'PUT'
      });
    } catch (error) {
      console.log(error);
    }


  } else if (evt.key === "F1") {
    formattingJavaScript(textarea);
    evt.preventDefault();
  } else if (evt.key === "F3") {
    translationFunction(textarea);
    evt.preventDefault();
  } else if (evt.key === "F2") {
    const selectedString = getSelectedString(textarea);
    if (selectedString === '') {
      const reg = /(?<=css`)[^`]+(?=`)/;
      const match = reg.exec(textarea.value);
      let str = match[0].replaceAll(/[\r\n]+/g, '');
      str = str.replaceAll(/((?<=[;{}:,])\s+)|(\s+(?=[{]))/g, '');
      textarea.value = textarea.value.replace(match[0], str);
      str = textarea.value;
      let points = substring(textarea.value, 'html`', 'connectedCallback()');
      let contents = textarea.value.substring(points[0], points[1]);
      contents = substringBeforeLast(contents, "`");
      const options = { indent_size: 2, space_in_empty_paren: true }
      textarea.value = textarea.value.replace(contents, html_beautify(contents, options));
      return;
    }
    let k, ss;

    const match = /(<*?[a-zA-Z0-9_-]+) +(style="([^"]+)")/.exec(selectedString);
    k = match[1]
    ss = match[3];
    textarea.value = textarea.value.replace(match[0], `class="${k}"`)
      .replaceAll(match[2], `class="${k}"`);
    const dst = k.startsWith('<') ? `${k.slice(1)}{
      ${ss}
      }` : `.${k}{
      ${ss}
      }`;
    textarea.value = textarea.value.replace("css`", "css`\n" + dst)
  } else if (evt.key === 'F6') {
    formatStyleLit(textarea);
    evt.preventDefault();
  } else if (evt.key === 'F7') {
    returnToParentDirectory();
    evt.preventDefault();
  } else if (evt.key === "F4") {
    insertLitHandler();
    evt.preventDefault();
  } else if (evt.key === "F5") {
    insertLitProperty();
    evt.preventDefault();
  } else if (evt.key === "F8") {
    executeSQL();
    evt.preventDefault();
  } else if (evt.key === "F9") {
    evalCode();
    evt.preventDefault();
  }


})
</script></body>

</html>