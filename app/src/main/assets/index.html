<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html {
            font-size: 10px;
            font-family: Roboto, Arial, sans-serif;
            word-wrap: break-word;
            color: #030303;
            background-color: #fff;
            -webkit-text-size-adjust: 100%;
        }

        body {
            margin: 0;
            padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            font-size: 1.2rem;
            overflow-x: hidden;
        }
    </style>
</head>

<body>
    <div>

    </div>
    <div style="height:61px;"></div>
    <custom-bar-renderer></custom-bar-renderer>
    <custom-bottom-sheet style="display: none;"></custom-bottom-sheet>
    <script src="custom-bottom-sheet.js"></script>
    <script src="custom-bar-renderer.js"></script>
    <script src="custom-media-item.js"></script>
    <script>
        let baseUri = window.location.hostname === "127.0.0.1" ? "http://192.168.8.55:8089" : "";
        async function loadFiles() {
            const res = await fetch(`${baseUri}/api/files?path=${new URL(window.location).searchParams.get("path") || ''}`);
            const files = await res.json();
            return files;
        }
        async function render() {
            const files = await loadFiles();
            const container = document.querySelector('div');

            const uri = new URL(window.location).searchParams.get("path") || '';
            files.sort((x, y) => {
                if (x.isDir === y.isDir)
                    return x.name.localeCompare(y.name);
                if (x.isDir)
                    return -1;
                else
                    return 1;
            }).forEach(element => {
                const customMediaItem = document.createElement('custom-media-item');
                if (element.isDir)
                    customMediaItem.setAttribute('src', "icon-folder-m.svg");
                else if (/\.(?:apk|pdf|zip|txt)$/.test(element.name)) {

                    customMediaItem.setAttribute('src', `icon-${/\.(apk|pdf|zip|txt)$/.exec(element.name)[1]}-m.svg`);
                } else if (element.name.endsWith('.jpg') || element.name.endsWith('.png')) {
                    customMediaItem.setAttribute('src', `${baseUri}/api/files?path=${encodeURIComponent(uri + "/" + element.name)}&isDir=0`);
                } else if (element.name.endsWith('.xlsx')) {
                    customMediaItem.setAttribute('src', `icon-xls-m.svg`);
                } else if (element.name.endsWith('.7z')) {
                    customMediaItem.setAttribute('src', `icon-zip-m.svg`);
                } else if (/\.(?:txt|epub|azw3|mobi)$/.test(element.name)) {
                    customMediaItem.setAttribute('src', `icon-txt-m.svg`);
                } else if (/\.(?:htm|xhtml|html)$/.test(element.name)) {
                    customMediaItem.setAttribute('src', `icon-code-m.svg`);
                } else if (/\.(?:mp3)$/.test(element.name)) {
                    customMediaItem.setAttribute('src', `icon-audio-m.svg`);
                } else if (/\.(?:mp4)$/.test(element.name)) {
                    customMediaItem.setAttribute('src', `${baseUri}/api/files?action=preview&path=${encodeURIComponent(uri + "/" + element.name)}`);
                } else {
                    customMediaItem.setAttribute('src', "icon-nor-m.svg");
                }
                customMediaItem.setAttribute('title', element.name);
                let path;
                if (element.isDir) {
                    path = `?path=${encodeURIComponent(uri + "/" + element.name)}&isDir=${element.isDir ? 1 : 0}`;
                } else {
                    path = `${baseUri}/api/files?path=${encodeURIComponent(uri + "/" + element.name)}&isDir=${element.isDir ? 1 : 0}`;
                }
                customMediaItem.setAttribute('href', path);
                container.appendChild(customMediaItem);
                customMediaItem.addEventListener('submit', evt => {
                    customBottomSheet.style.display = 'block';
                    customBottomSheet.dataset.path = `?path=${encodeURIComponent(uri + "/" + element.name)}&isDir=${element.isDir ? 1 : 0}`;
                });
            });
        }
        render();
        const customBottomSheet = document.querySelector('custom-bottom-sheet');
        customBottomSheet.addEventListener('delete', async evt => {
            evt.stopPropagation();
            fetch(`${baseUri}/api/files${evt.currentTarget.dataset.path}&action=delete`)
        });

    </script>
</body>

</html>